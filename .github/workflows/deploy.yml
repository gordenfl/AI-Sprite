name: CI & CD

on:
    push:
        branches: [ "main" ]
    pull_request:
        branches: [ "main" ]

env:
    IMAGE_NAME: ghcr.io

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        permissions:
            packages: write
            contents: read
        
        steps:
            - uses: actions/checkout@v4
            - name: SET IMAGE_NAME (lowercase)
              shell: bash
              run: |
                # ${GITHUB_REPOSITORY,,} æ˜¯ Bash çš„â€œå…¨éƒ¨è½¬å°å†™â€è¯­æ³•
                #echo "IMAGE_NAME=${REGISTRY}/${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV
                #echo "IMAGE_NAME=ghcr.io/$(echo \"$GITHUB_REPOSITORY\" | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_ENV"
                echo IMAGE_NAME=ghcr.io/$(echo "$GITHUB_REPOSITORY" | tr '[:upper:]' '[:lower:]') >> "$GITHUB_ENV"



            # è¿™é‡Œåœ¨æ„å»ºé•œåƒ
            - name: Build Docker image
              run: docker build -f ./AINewsCollector/Dockerfile -t $IMAGE_NAME:${{ github.sha }} ./AINewsCollector # åœ¨è¿™é‡Œåˆ›å»ºimage

            # ç™»å½•GHCR
            - name: Login to GHCR
              uses: docker/login-action@v3
              with:
                registry: ghcr.io
                username: ${{ github.actor }}
                password: ${{ secrets.GITHUB_TOKEN }}
            
            # æ¨é€é•œåƒåˆ°DockerHub
            - name: Push Docker Image
              run: |
                docker tag $IMAGE_NAME:${{ github.sha }} $IMAGE_NAME:latest
                docker push $IMAGE_NAME:${{ github.sha }}
                docker push $IMAGE_NAME:latest

  deploy:
    needs: build-and-push
      runs-on: ubuntu-latest
    steps:
      # â‘  é‡æ–°è®¡ç®— IMAGE_NAMEï¼ˆæ¯ä¸ª job å•ç‹¬æ¥ä¸€éæœ€çœäº‹ï¼‰
      - name: Set IMAGE_NAME (lowercase)
        id: set_image
        run: |
          echo "IMAGE_NAME=ghcr.io/$(echo $GITHUB_REPOSITORY | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      # â‘¡ å°† IMAGE_NAME å’Œ CR_PAT ä¼ è¿›è¿œç¨‹ SSH ä¼šè¯
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: IMAGE_NAME,CR_PAT,GITHUB_ACTOR        # ğŸ‘ˆ è¿™ä¸‰ä¸ªç¯å¢ƒå˜é‡æ³¨å…¥è¿œç¨‹ shell
          script: |
            # --- ç™»å½• GHCRï¼ˆé•œåƒæ˜¯ç§æœ‰æ‰éœ€è¦ï¼›ä½ ä¹Ÿå¯ä»¥æ”¹æˆ public çœå»è¿™ä¸€æ­¥ï¼‰---
            if [ -n "$CR_PAT" ]; then
              echo "$CR_PAT" | docker login ghcr.io -u "$GITHUB_ACTOR" --password-stdin
            fi

            # --- æ‹‰å–æœ€æ–°é•œåƒ ---
            docker pull $IMAGE_NAME:latest

            # --- åœæ‰æ—§å®¹å™¨å¹¶åˆ é™¤ ---
            docker rm -f ainewscollector || true

            # --- å¯åŠ¨æ–°å®¹å™¨ ---
            docker run -d \
              --name ainewscollector \
              -p 8501:8501 \
              -e STREAMLIT_SERVER_HEADLESS=true \
              -e STREAMLIT_SERVER_PORT=8501 \
              -e STREAMLIT_SERVER_ENABLECORS=false \
              $IMAGE_NAME:latest

            # --- æ¸…ç† 24h å‰çš„æ‚¬æŒ‚é•œåƒ ---
            docker image prune -f --filter "until=24h"
   
